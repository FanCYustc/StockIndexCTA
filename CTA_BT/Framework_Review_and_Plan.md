# CTA_BT 框架现状与改进计划

## 1. 现有框架原理与结构介绍 (Current Architecture)

`CTA_BT` 是一个针对股指期货（IF/IC/IM）的单因子日内回测框架。其核心思想是基于分钟级别的 K 线数据，进行事件驱动（按时间步进）的模拟交易。

### 1.1 核心组件

*   **`BaseStrategy` (在 `CTA_BTv3.py` 中定义)**
    *   **职责**：作为所有策略的基类，定义了生命周期管理和标准接口。
    *   **生命周期**：
        1.  `__init__`：初始化每日状态（PnL, Position）。
        2.  `getOrgData` & `prepare_data`：每日开始前加载并预处理数据。
        3.  `run_backtest` (Instance method)：每日内部的分钟级循环 (Minute Loop)。
        4.  `GetSig(i)`：**核心逻辑**。策略在第 `i` 分钟根据历史信息决定目标仓位 `position`。
        5.  `CmpRet`：计算单分钟收益。
    *   **交易机制**：
        *   目前逻辑为：在第 `i` 分钟根据 `GetSig(i)` 更新仓位，并计算该分钟的涨跌幅收益。
        *   **潜在风险**：如果 `GetSig(i)` 使用了第 `i` 分钟的 Close 价格，则存在未来函数风险。需确保信号生成仅依赖 `i` 分钟之前的信息，或明确定义为“收盘价信号，次分钟开盘成交”。

*   **`run_backtest` (Driver Function)**
    *   **职责**：负责整个回测的时间轴推进、结果汇总和可视化。
    *   **流程**：
        1.  读取交易日历 (`tradedates.csv`)。
        2.  遍历每一个交易日：
            *   实例化策略类。
            *   调用 `stg.run_backtest()` 运行当日回测。
            *   收集当日 `PNL` 和 `trade_records`。
        3.  **统计与可视化**：
            *   计算基础指标：累计收益、Sharpe、MaxDD、Calmar。
            *   绘图：累计收益曲线。
            *   保存：`_trades.csv` (分钟级明细) 和 `.csv` (日报表)。

---

## 2. 改进计划 (Improvement Plan)

本计划旨在将框架从简单的“回测工具”升级为支持“申万宏源研报复现”与“因子库构建”的专业研究平台。建议按阶段实施。

### 第一阶段：评估体系完善与标准化 (Phase 1: Metrics & Standardization)
**目标**：支持“参数鲁棒性”评估，提供更全面的策略体检报告。

1.  **扩展评估指标 (Enhanced Metrics)**
    *   **胜率 (Win Rate)**：`盈利交易次数 / 总交易次数`。
    *   **盈亏比 (Profit-Loss Ratio)**：`平均盈利 / 平均亏损`。
    *   **单笔平均收益 (Avg Net Profit per Trade)**：评估扣费前的策略期望值。
    *   **持仓分析**：平均持仓时间、多空持仓比例（检查是否特定方向暴露）。
    *   **连亏分析**：最大连续亏损次数（心理压力评估）。
2.  **可视化增强 (Visualization)**
    *   **回撤曲线 (Underwater Plot)**：独立绘制回撤幅度随时间变化的图表，直观展示风险释放过程。
    *   **交易点标记**：在局部 K 线图上标记买卖点，用于人工核对逻辑正确性。
3.  **标准化输出**
    *   统一所有策略的输出格式，自动生成包含上述指标的 `Report.txt` 或 Markdown 片段，便于直接粘贴到 `Strategy_Explanation.md`。

### 第二阶段：架构解耦与因子库构建 (Phase 2: Decoupling & Factor Library)
**目标**：将“因子计算”与“交易执行”分离，构建可复用的因子仓库。

1.  **解耦设计 (Decoupling)**
    *   **拆分 `GetSig`**：将当前的 `GetSig` 拆分为两个明确步骤：
        1.  **`calculate_indicators(data)`**：纯数学计算，生成技术指标序列（如 MA, RSI, Bollinger Bands）。
        2.  **`generate_signal(indicators)`**：交易逻辑，根据指标生成多空信号（1, -1, 0）。
    *   **优势**：同一套因子计算逻辑可以轻松接入不同的交易模式（趋势跟踪 vs 均值回归），便于快速实验。
2.  **执行逻辑规范化 (Execution Strictness)**
    *   **明确“次分钟开盘成交”模式**：为了杜绝未来函数，增加一个标准执行模式——信号在 `i` 分钟收盘生成，成交价强制锁定为 `i+1` 分钟的 Open Price。
3.  **向量化加速 (Vectorization)**
    *   对于简单的指标计算，尽量使用向量化操作（Pandas/Numpy）替代 `for` 循环，显著提升回测速度。

### 第三阶段：仿真增强与研究工具 (Phase 3: Simulation & Research Tools)
**目标**：提升回测的真实性，并提供批量研究工具。

1.  **仿真度提升 (Simulation Accuracy)**
    *   **参数搜索和策略组合**：在回测框架的基础上构建超参数选择的测试程序，针对策略在不同超参数上的表现细化策略（如同个策略不同参数均摊仓位）。
    *   **参数敏感性热力图**：自动扫描参数邻域（例如 N=20±5），生成热力图。**目的不是为了寻优，而是为了验证在参数变化时策略表现是否平滑（鲁棒性验证）。**
2.  **效率工具 (Research Efficiency)**
    *   **批量回测脚本**：一键运行所有已复现的策略，生成汇总对比报表，便于横向比较因子表现。

### 实施路线图 (Roadmap)
1.  **当前重点**：在复现申万策略的过程中，手动实现 Phase 1 中的核心指标（胜率、盈亏比），并逐步集成到 `CTA_BTv3.py` 中。
2.  **中期目标**：在积累了 3-5 个不同类型的策略后，进行 Phase 2 的重构，提取公共因子计算模块。
3.  **长期目标**：完成 Phase 3 工具链开发，形成完整的量化研究工作流。